<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Screenshot Annotator - Debug Version</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 10px; background: #f9f9f9; }
        .debug-box { background: white; border: 2px solid #007cba; padding: 15px; margin: 10px 0; border-radius: 8px; }
        .error { color: #d32f2f; font-weight: bold; }
        .success { color: #388e3c; font-weight: bold; }
        .info { color: #1976d2; }
        button { background: #007cba; color: white; border: none; padding: 8px 15px; margin: 5px; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 11px; }
        .test-section { border-left: 4px solid #007cba; padding-left: 10px; margin: 10px 0; }
    </style>
</head>
<body>
    <h2>🔧 Extension Debug Center</h2>
    <p>This page will automatically run diagnostics and show you exactly what's happening.</p>
    
    <div class="debug-box">
        <h3>🔍 Diagnostic Results</h3>
        <div id="results">Running diagnostics...</div>
        <button onclick="copyResults()">📋 Copy All Results</button>
        <button onclick="runTests()">🔄 Run Tests Again</button>
        <button onclick="testCapture()">📸 Test Screenshot Capture</button>
    </div>
    
    <div class="debug-box">
        <h3>📊 Current Status</h3>
        <div id="status">Checking...</div>
    </div>
    
    <div class="debug-box">
        <h3>🧪 Manual Tests</h3>
        <button onclick="testBackground()">Test Background Script</button>
        <button onclick="testStorage()">Test Storage</button>
        <button onclick="checkPermissions()">Check Permissions</button>
        <button onclick="simulateScreenshot()">Simulate Screenshot</button>
    </div>
    
    <div class="debug-box">
        <h3>📋 Raw Debug Output</h3>
        <pre id="rawOutput">Starting diagnostics...\n</pre>
    </div>

    <script>
        let debugMessages = [];
        
        function addDebug(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const entry = `[${timestamp}] ${message}`;
            debugMessages.push(entry);
            
            // Update raw output
            const rawOutput = document.getElementById('rawOutput');
            rawOutput.textContent = debugMessages.join('\n') + '\n';
            rawOutput.scrollTop = rawOutput.scrollHeight;
            
            // Update results
            updateResults();
        }
        
        function updateResults() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = debugMessages.map(msg => {
                if (msg.includes('❌') || msg.includes('ERROR')) {
                    return `<div class="error">${msg}</div>`;
                } else if (msg.includes('✅') || msg.includes('SUCCESS')) {
                    return `<div class="success">${msg}</div>`;
                } else {
                    return `<div class="info">${msg}</div>`;
                }
            }).join('');
        }
        
        function copyResults() {
            const text = debugMessages.join('\n');
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(() => {
                    addDebug('📋 Results copied to clipboard!');
                });
            } else {
                // Fallback
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                addDebug('📋 Results selected - press Ctrl+C to copy');
            }
        }
        
        function runTests() {
            debugMessages = ['🔧 Running comprehensive diagnostics...'];
            
            // Test 1: Basic JavaScript
            try {
                addDebug('✅ JavaScript is working');
                addDebug('✅ DOM is accessible');
            } catch (e) {
                addDebug('❌ JavaScript error: ' + e.message);
            }
            
            // Test 2: Chrome APIs
            if (typeof chrome !== 'undefined') {
                addDebug('✅ Chrome object exists');
                
                if (chrome.storage) {
                    addDebug('✅ Chrome storage API available');
                } else {
                    addDebug('❌ Chrome storage API missing');
                }
                
                if (chrome.runtime) {
                    addDebug('✅ Chrome runtime API available');
                } else {
                    addDebug('❌ Chrome runtime API missing');
                }
                
                if (chrome.tabs) {
                    addDebug('✅ Chrome tabs API available');
                } else {
                    addDebug('❌ Chrome tabs API missing');
                }
            } else {
                addDebug('❌ Chrome APIs not available - not running as extension');
            }
            
            // Test 3: Extension context
            try {
                if (chrome && chrome.runtime && chrome.runtime.id) {
                    addDebug('✅ Running in extension context, ID: ' + chrome.runtime.id);
                } else {
                    addDebug('❌ Not running in proper extension context');
                }
            } catch (e) {
                addDebug('❌ Extension context error: ' + e.message);
            }
            
            // Test 4: Check for other scripts
            if (window.screenshotAnnotator) {
                addDebug('✅ ScreenshotAnnotator instance found');
            } else {
                addDebug('❌ ScreenshotAnnotator instance NOT found');
            }
            
            if (window.tempStorage) {
                addDebug('✅ TempStorage instance found');
            } else {
                addDebug('❌ TempStorage instance NOT found');
            }
            
            addDebug('🏁 Basic diagnostics complete');
        }
        
        function testBackground() {
            addDebug('🏓 Testing background script...');
            
            if (typeof chrome !== 'undefined' && chrome.runtime) {
                chrome.runtime.sendMessage({action: 'ping'}, function(response) {
                    if (chrome.runtime.lastError) {
                        addDebug('❌ Background script error: ' + chrome.runtime.lastError.message);
                    } else if (response) {
                        addDebug('✅ Background script responding: ' + JSON.stringify(response));
                    } else {
                        addDebug('❌ Background script not responding (no response)');
                    }
                });
            } else {
                addDebug('❌ Cannot test background - Chrome runtime not available');
            }
        }
        
        function testStorage() {
            addDebug('💾 Testing storage...');
            
            if (typeof chrome !== 'undefined' && chrome.storage) {
                chrome.storage.local.get('screenshots', function(result) {
                    const screenshots = result.screenshots || [];
                    addDebug(`📊 Storage contains ${screenshots.length} screenshots`);
                    
                    if (screenshots.length > 0) {
                        screenshots.forEach((s, i) => {
                            addDebug(`Screenshot ${i}: ${s.title || 'No title'} - ${s.imageData ? 'Has image data' : 'NO IMAGE DATA'}`);
                        });
                    }
                });
                
                // Test storage quota
                if (chrome.storage.local.getBytesInUse) {
                    chrome.storage.local.getBytesInUse(function(bytes) {
                        const quota = chrome.storage.local.QUOTA_BYTES || 10485760;
                        addDebug(`💾 Storage usage: ${Math.round(bytes/1024)}KB / ${Math.round(quota/1024)}KB`);
                    });
                }
            } else {
                addDebug('❌ Cannot test storage - Chrome storage not available');
            }
        }
        
        function checkPermissions() {
            addDebug('🔐 Checking permissions...');
            
            if (typeof chrome !== 'undefined' && chrome.permissions) {
                chrome.permissions.getAll(function(permissions) {
                    addDebug('✅ Permissions: ' + JSON.stringify(permissions));
                });
            } else {
                addDebug('⚠️ Cannot check permissions - API not available');
            }
        }
        
        function testCapture() {
            addDebug('📸 Testing screenshot capture...');
            
            if (typeof chrome !== 'undefined' && chrome.runtime) {
                chrome.runtime.sendMessage({action: 'captureVisibleTab'}, function(response) {
                    if (chrome.runtime.lastError) {
                        addDebug('❌ Capture failed: ' + chrome.runtime.lastError.message);
                    } else if (response && response.success && response.imageData) {
                        addDebug('✅ Capture successful! Image size: ' + response.imageData.length + ' characters');
                    } else if (response && response.error) {
                        addDebug('❌ Capture error: ' + response.error);
                    } else {
                        addDebug('❌ Capture failed - unexpected response: ' + JSON.stringify(response));
                    }
                });
            } else {
                addDebug('❌ Cannot test capture - Chrome runtime not available');
            }
        }
        
        function simulateScreenshot() {
            addDebug('🧪 Simulating screenshot save...');
            
            const testScreenshot = {
                id: Date.now().toString(),
                title: 'Test Screenshot - ' + new Date().toLocaleString(),
                imageData: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg==',
                timestamp: new Date().toISOString(),
                annotations: []
            };
            
            if (typeof chrome !== 'undefined' && chrome.storage) {
                chrome.storage.local.get('screenshots', function(result) {
                    const screenshots = result.screenshots || [];
                    screenshots.push(testScreenshot);
                    
                    chrome.storage.local.set({screenshots: screenshots}, function() {
                        if (chrome.runtime.lastError) {
                            addDebug('❌ Failed to save test screenshot: ' + chrome.runtime.lastError.message);
                        } else {
                            addDebug('✅ Test screenshot saved successfully');
                            addDebug('📊 Total screenshots now: ' + screenshots.length);
                        }
                    });
                });
            } else {
                addDebug('❌ Cannot simulate - Chrome storage not available');
            }
        }
        
        // Auto-run diagnostics when page loads
        window.onload = function() {
            setTimeout(runTests, 500);
        };
    </script>
</body>
</html>