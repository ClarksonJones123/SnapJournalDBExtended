<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <style>
    body {
      width: 400px;
      padding: 16px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      background: #f8f9fa;
    }
    
    .header {
      text-align: center;
      margin-bottom: 16px;
    }
    
    .header h1 {
      font-size: 18px;
      color: #333;
      margin: 0 0 8px 0;
    }
    
    .memory-info {
      background: #e3f2fd;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      color: #1565c0;
      text-align: center;
      margin-bottom: 16px;
    }
    
    .controls {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 16px;
    }
    
    button {
      padding: 10px 16px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .btn-primary {
      background: #1976d2;
      color: white;
    }
    
    .btn-primary:hover {
      background: #1565c0;
    }
    
    .btn-primary:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .btn-success {
      background: #388e3c;
      color: white;
    }
    
    .btn-success:hover {
      background: #2e7d32;
    }
    
    .btn-danger {
      background: #d32f2f;
      color: white;
    }
    
    .btn-export {
      background: #9c27b0;
      color: white;
    }
    
    .btn-export:hover {
      background: #7b1fa2;
    }
    
    .btn-export:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .timestamp-info {
      display: flex;
      flex-direction: column;
      gap: 2px;
      font-size: 11px;
      color: #666;
    }
    
    .capture-date {
      font-weight: 500;
    }
    
    .capture-time {
      color: #888;
    }
    
    .technical-info {
      display: flex;
      gap: 8px;
      font-size: 11px;
      color: #666;
      margin-top: 4px;
    }
    
    .btn-danger:hover {
      background: #c62828;
    }
    
    .screenshots-section {
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      background: white;
      max-height: 300px;
      overflow-y: auto;
    }
    
    .screenshots-header {
      padding: 12px 16px;
      border-bottom: 1px solid #e0e0e0;
      font-weight: 600;
      color: #333;
      background: #f5f5f5;
    }
    
    .screenshots-list {
      min-height: 80px;
    }
    
    .screenshot-item {
      padding: 12px 16px;
      border-bottom: 1px solid #f0f0f0;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .screenshot-preview {
      margin-bottom: 8px;
    }
    
    .screenshot-preview img {
      width: 100%;
      max-width: 360px;
      height: auto;
      border-radius: 4px;
      border: 1px solid #e0e0e0;
      background: #f5f5f5;
    }
    
    .screenshot-item:hover {
      background: #f8f9fa;
    }
    
    .screenshot-item:last-child {
      border-bottom: none;
    }
    
    .screenshot-item.selected {
      background: #e3f2fd;
      border-left: 4px solid #1976d2;
    }
    
    .screenshot-title {
      font-weight: 500;
      font-size: 13px;
      color: #333;
      margin-bottom: 4px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .screenshot-details {
      font-size: 11px;
      color: #666;
      display: flex;
      justify-content: space-between;
    }
    
    .empty-state {
      padding: 32px 16px;
      text-align: center;
      color: #999;
      font-size: 13px;
    }
    
    .status {
      padding: 8px 12px;
      border-radius: 4px;
      margin: 8px 0;
      font-size: 12px;
      font-weight: 500;
    }
    
    .status.success {
      background: #e8f5e8;
      color: #2e7d32;
      border: 1px solid #c8e6c9;
    }
    
    .status.error {
      background: #ffebee;
      color: #c62828;
      border: 1px solid #ffcdd2;
    }
    
    .status.info {
      background: #e3f2fd;
      color: #1565c0;
      border: 1px solid #bbdefb;
    }
    
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <!-- DEBUG OUTPUT SECTION -->
  <div id="debugSection" style="background: #f0f0f0; border: 1px solid #ccc; margin: 5px; padding: 10px; font-family: monospace; font-size: 11px; max-height: 200px; overflow-y: auto;">
    <div style="font-weight: bold; color: #333; margin-bottom: 5px;">üîç Debug Output (Auto-Running):</div>
    <div id="debugOutput">Loading diagnostics...</div>
    <button id="copyDebugBtn" style="margin-top: 5px; padding: 2px 8px; font-size: 10px;">üìã Copy Debug Info</button>
    <button id="toggleDebugBtn" style="margin-top: 5px; padding: 2px 8px; font-size: 10px;">üëÅÔ∏è Toggle Debug</button>
  </div>

  <div class="header">
    <h1>üì∏ Screenshot Annotator</h1>
    <div class="memory-info">
      Memory: <span id="memoryUsage">0 KB</span> ‚Ä¢ Screenshots: <span id="screenshotCount">0</span>
    </div>
  </div>

  <div id="status" class="status hidden"></div>

  <div class="controls">
    <button id="captureBtn" class="btn-primary">
      üì∑ Capture & Annotate (ANY PAGE!)
    </button>
    
    <button id="annotateBtn" class="btn-success" disabled>
      ‚úèÔ∏è Start Annotating
    </button>
    
    <button id="exportPdfBtn" class="btn-export" disabled>
      üìÑ Export PDF Journal
    </button>
    
    <button id="clearBtn" class="btn-danger">
      üóëÔ∏è Clear All Screenshots
    </button>
  </div>

  <div class="screenshots-section">
    <div class="screenshots-header">
      Screenshots
    </div>
    <div id="screenshotsList" class="screenshots-list">
      <div class="empty-state">
        No screenshots yet.<br>Click "Capture Current Page" to get started.
      </div>
    </div>
  </div>

  <!-- Load temporary storage system first -->
  <script src="temp-storage.js"></script>
  <script src="popup-debug.js"></script>
  <script src="popup.js"></script>
  
  <script>
    // EMBEDDED DEBUG SYSTEM - RUNS AUTOMATICALLY
    let debugOutput = [];
    let debugVisible = true;
    
    function debugLog(message, data = null) {
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = `[${timestamp}] ${message}`;
        if (data) {
            debugOutput.push(`${logEntry}\n  Data: ${JSON.stringify(data, null, 2)}`);
        } else {
            debugOutput.push(logEntry);
        }
        updateDebugDisplay();
    }
    
    function debugError(message, error = null) {
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = `[${timestamp}] ‚ùå ${message}`;
        if (error) {
            debugOutput.push(`${logEntry}\n  Error: ${error.toString()}`);
        } else {
            debugOutput.push(logEntry);
        }
        updateDebugDisplay();
    }
    
    function updateDebugDisplay() {
        const debugDiv = document.getElementById('debugOutput');
        if (debugDiv) {
            debugDiv.innerHTML = debugOutput.slice(-20).join('\n').replace(/\n/g, '<br>');
            debugDiv.scrollTop = debugDiv.scrollHeight;
        }
    }
    
    // AUTO-RUN DIAGNOSTICS
    document.addEventListener('DOMContentLoaded', () => {
        debugLog('üîç Starting embedded diagnostics...');
        
        // Check environment
        debugLog('Checking Chrome APIs...');
        if (typeof chrome !== 'undefined') {
            debugLog('‚úÖ Chrome APIs available');
            if (chrome.storage) debugLog('‚úÖ Chrome storage available');
            if (chrome.runtime) debugLog('‚úÖ Chrome runtime available');
            if (chrome.tabs) debugLog('‚úÖ Chrome tabs available');
        } else {
            debugError('‚ùå Chrome APIs not available');
        }
        
        // Check DOM elements
        debugLog('Checking DOM elements...');
        const requiredElements = ['captureBtn', 'annotateBtn', 'screenshotsList'];
        let foundElements = 0;
        requiredElements.forEach(id => {
            if (document.getElementById(id)) {
                foundElements++;
            } else {
                debugError(`Missing element: ${id}`);
            }
        });
        debugLog(`‚úÖ Found ${foundElements}/${requiredElements.length} required elements`);
        
        // Test background script
        if (typeof chrome !== 'undefined' && chrome.runtime) {
            debugLog('Testing background script communication...');
            chrome.runtime.sendMessage({action: 'ping'}, (response) => {
                if (chrome.runtime.lastError) {
                    debugError('Background script error', chrome.runtime.lastError);
                } else if (response) {
                    debugLog('‚úÖ Background script responding', response);
                } else {
                    debugError('Background script not responding');
                }
            });
        }
        
        // Check storage
        if (typeof chrome !== 'undefined' && chrome.storage) {
            debugLog('Checking storage contents...');
            chrome.storage.local.get('screenshots', (result) => {
                const screenshots = result.screenshots || [];
                debugLog(`üìä Found ${screenshots.length} screenshots in storage`);
                
                if (screenshots.length > 0) {
                    screenshots.forEach((s, i) => {
                        debugLog(`Screenshot ${i}: ${s.title || 'No title'}`, {
                            id: s.id,
                            hasImageData: !!s.imageData,
                            imageDataSize: s.imageData ? Math.round(s.imageData.length/1024) + 'KB' : 'N/A',
                            timestamp: s.timestamp
                        });
                    });
                }
            });
            
            // Check storage quota
            if (chrome.storage.local.getBytesInUse) {
                chrome.storage.local.getBytesInUse((bytes) => {
                    const quota = chrome.storage.local.QUOTA_BYTES || 10485760;
                    debugLog(`üíæ Storage: ${Math.round(bytes/1024)}KB / ${Math.round(quota/1024)}KB (${Math.round(bytes/quota*100)}%)`);
                });
            }
        }
        
        // Check ScreenshotAnnotator instance
        setTimeout(() => {
            if (window.screenshotAnnotator) {
                debugLog('‚úÖ ScreenshotAnnotator instance found', {
                    screenshots: window.screenshotAnnotator.screenshots?.length || 0,
                    initialized: window.screenshotAnnotator.isInitialized || false
                });
            } else {
                debugError('‚ùå ScreenshotAnnotator instance not found');
            }
            
            debugLog('üèÅ Diagnostics complete - ready for copy/paste');
        }, 2000);
        
        // Setup debug controls
        document.getElementById('copyDebugBtn').addEventListener('click', () => {
            const debugText = debugOutput.join('\n');
            navigator.clipboard.writeText(debugText).then(() => {
                debugLog('üìã Debug info copied to clipboard!');
            }).catch(() => {
                // Fallback - show in alert for manual copy
                const textarea = document.createElement('textarea');
                textarea.value = debugText;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                debugLog('üìã Debug info selected - press Ctrl+C to copy');
            });
        });
        
        document.getElementById('toggleDebugBtn').addEventListener('click', () => {
            const debugSection = document.getElementById('debugSection');
            debugVisible = !debugVisible;
            debugSection.style.display = debugVisible ? 'block' : 'none';
            document.getElementById('toggleDebugBtn').textContent = debugVisible ? 'üëÅÔ∏è Hide Debug' : 'üëÅÔ∏è Show Debug';
        });
    });
    
    // Intercept console.log to capture all output
    const originalLog = console.log;
    const originalError = console.error;
    
    console.log = function(...args) {
        debugLog(`LOG: ${args.join(' ')}`);
        originalLog.apply(console, args);
    };
    
    console.error = function(...args) {
        debugError(`ERROR: ${args.join(' ')}`);
        originalError.apply(console, args);
    };
  </script>
</body>
</html>